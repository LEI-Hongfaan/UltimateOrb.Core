using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Numerics;
using System.Text;

namespace UltimateOrb.Mathematics;

public static partial class UInt16PrimeData {

    // 4 KiB bitmap packed as 512 `UInt64`s (little-endian bytes).
    public static ReadOnlySpan<UInt64> OddPrimeBitmap => [
        0X816d129a64b4cb6eUL, 0X2196820d864a4c32UL, 0Xa48961205a0434c9UL, 0X4a2882d129861144UL, 0X0834992132424030UL, 0X148a48844225064bUL, 0X0b40b4086c304205UL, 0X65048928125108a0UL,
        0X80124496804c3098UL, 0Xc02104c941124221UL, 0X0804490000982d32UL, 0X220825b082689681UL, 0X9004265940a28948UL, 0X6900924430434006UL, 0X12410da408088210UL, 0X086122d22400c060UL,
        0X0110d301821b0484UL, 0X14916022c044a002UL, 0X092094d204a6400cUL, 0X4ca2100800522094UL, 0Xa48b081051018200UL, 0X034c108144309a25UL, 0X2084490880522502UL, 0X241140a218003250UL,
        0X0a41a00101840128UL, 0X2926000836004512UL, 0X10100480c0618283UL, 0Xc20c26584822006dUL, 0X4520582024894810UL, 0X10c0250219002488UL, 0X802832ca01140868UL, 0X60901300264b0400UL,
        0X32100100d0258082UL, 0X430800112186430cUL, 0X0092900c10480424UL, 0X24880906002d2043UL, 0X530082090932c040UL, 0X4000814196800880UL, 0X2058489608481048UL, 0X926094022080c329UL,
        0X05a0104422812000UL, 0X000a042049019040UL, 0Xc02c801348348924UL, 0X0800084524002982UL, 0X04d0048452043698UL, 0X1865328244908a00UL, 0X28024001020a0090UL, 0X861104309204a440UL,
        0Xc90804522c004208UL, 0X4424990912486084UL, 0X1000211403002400UL, 0X4040208805321a01UL, 0X6030014084c30906UL, 0Xa2020c9011680218UL, 0X8224148929860004UL, 0X0880190480084102UL,
        0X020004a442681210UL, 0X120100100c061061UL, 0X6512422194032010UL, 0X140128040a0c9418UL, 0X014000d040a40a29UL, 0X4882402d20410490UL, 0X24080130100020c1UL, 0X8229020024845904UL,
        0X4816814802586100UL, 0Xa0ca000611210010UL, 0X4200b09104000240UL, 0X2514480906810c04UL, 0X860a00a011252092UL, 0X084520004802c10cUL, 0X0022130406980032UL, 0X1282441481480482UL,
        0Xd028804340101824UL, 0X2c00d86424812004UL, 0X020000a241081209UL, 0X180110c04120ca41UL, 0X20941220a41804a4UL, 0X048044320240a083UL, 0X8a6086400c001800UL, 0X0082010512886400UL,
        0X04096110c101a24aUL, 0X0840b40160008801UL, 0X0494400880030106UL, 0X02520c028029208aUL, 0X0264848000844201UL, 0X2122404430004832UL, 0X20d004a0c3080200UL, 0X5228004040161840UL,
        0X0810180114820890UL, 0X809320a00a408209UL, 0X010500522000c008UL, 0X0000820c06114010UL, 0X908028009a44904bUL, 0X0028024309064a04UL, 0X4480096500180134UL, 0X1448618202240003UL,
        0X5108340028120041UL, 0X6084892890120504UL, 0X8249402610491012UL, 0X8840240a01109100UL, 0X2ca2500004104c10UL, 0X125001b00a489040UL, 0X9228a00904a40008UL, 0X4120022110430002UL,
        0X00520c0408003281UL, 0X8101021020844921UL, 0X6984010122404810UL, 0X00884402c80130c1UL, 0X006112c02d02010cUL, 0X0812014030c000a0UL, 0X840140948000200bUL, 0X0b00841000320040UL,
        0X41848a2906010024UL, 0X80034c9408081080UL, 0X5020204140964001UL, 0X20a44040a2892522UL, 0X104a212001288602UL, 0X4225044008140008UL, 0X2100920410432102UL, 0X84030922184ca011UL,
        0X0124228204108941UL, 0X0900c10884080814UL, 0X368000028a41b042UL, 0X0200009124a04904UL, 0X0806080102924194UL, 0X80892816d0010009UL, 0X500c900168000060UL, 0X4130424080400120UL,
        0X0049400681252000UL, 0X1820a00049120108UL, 0X28241000a6010530UL, 0X12880020c8200200UL, 0X420126020092900cUL, 0X0102422404004916UL, 0X001008801a0c8088UL, 0X1169008844940260UL,
        0X00841324a0120830UL, 0X30002810c0650082UL, 0Xc801061101200304UL, 0X0c82100820c20080UL, 0Xb0004006520c0213UL, 0X1004869801104061UL, 0X4180416014920884UL, 0X204140228104101aUL,
        0X1060340841005229UL, 0X0884004010012800UL, 0X0252040448209042UL, 0X000d820004200800UL, 0X4020480510024082UL, 0X00c0240601000099UL, 0X0844101221048268UL, 0X0916d020a6400004UL,
        0X92090c20024124c9UL, 0X4309004000001240UL, 0X0024110102982084UL, 0X3041089003002443UL, 0X100882804c205824UL, 0X2010094106812524UL, 0X244a001080441018UL, 0Xc00030802894010dUL,
        0X0900020c84106002UL, 0X20c2041008018202UL, 0X1100001804060968UL, 0X0c028221100b0890UL, 0X024100260008b610UL, 0X8024201a21244a01UL, 0X0002402d00024400UL, 0Xa69020001020948bUL,
        0X016186112c001340UL, 0X4830810402104180UL, 0X108a218050282048UL, 0X4248101009100804UL, 0X0520c06092820ca0UL, 0X82080400014020d2UL, 0X484180480002822dUL, 0X0084030404910010UL,
        0X22c06400006804c2UL, 0X9100860944320840UL, 0X2400486400012802UL, 0X8652210043009010UL, 0X8808204020908b41UL, 0X6084020020134404UL, 0X1008003040249081UL, 0X4320041001020808UL,
        0X4c800168129040b4UL, 0X10404912c0080018UL, 0X104c248941001a24UL, 0X41204a0910520400UL, 0X0610081411692248UL, 0X4000100028848024UL, 0X2806480826080110UL, 0X200a048442011400UL,
        0X1224820008820100UL, 0X04109040a0404004UL, 0X10802c2010402290UL, 0X8101005804004328UL, 0X0004832120094810UL, 0Xa0106c000044a442UL, 0Xc948808300804844UL, 0X04b0100502000000UL,
        0X0408409210290413UL, 0X1900201900228244UL, 0X41008a6090810120UL, 0Xa2020004104502c0UL, 0X4201204921104009UL, 0X0422014414002c30UL, 0X1080210489089202UL, 0X0004804140200105UL,
        0X01325864b0400912UL, 0X80c1090441009008UL, 0X0124009a00900861UL, 0X0806820526020812UL, 0X2418002048200008UL, 0X0009001100020348UL, 0X04009801104a0184UL, 0X80812000c0008618UL,
        0X4a0cb40005301004UL, 0X4420002802912982UL, 0Xa2014080912c00c0UL, 0X080020c309041200UL, 0X2c00000422100c02UL, 0X32120000c0008611UL, 0X5005024040808940UL, 0X4d120a60a4826086UL,
        0X1402098012089080UL, 0X9044008a20240148UL, 0X0012d10002010404UL, 0X248121320040040aUL, 0X8908040220841908UL, 0X4482186802022480UL, 0X8001280040210042UL, 0X020c801140208245UL,
        0X2020400190402400UL, 0X2009400019282050UL, 0X0820804060048008UL, 0X2424110034094930UL, 0X02920400c2410082UL, 0X0100a0020c008024UL, 0X0100d02104416006UL, 0X1291048412480001UL,
        0X1841120044240008UL, 0X2004520080410c26UL, 0X0218482090240009UL, 0X8a0014d009a20300UL, 0X40149820004a2584UL, 0X144000000005a200UL, 0X090084802c205801UL, 0X41b0020802912020UL,
        0X0218001009003008UL, 0X0844240000020221UL, 0X0c021244b2006012UL, 0X20500420c84080c0UL, 0X5329040b04b00005UL, 0X2920820030486100UL, 0X1043202253001600UL, 0X004000d204800048UL,
        0X08040029800344a2UL, 0X84092830406404c0UL, 0Xc000920221805044UL, 0X0000800822886010UL, 0X2081009683048418UL, 0X5100848845000205UL, 0X00944b4186512020UL, 0X80584c2011080080UL,
        0X0805008920060304UL, 0X0982004000900522UL, 0X20c241a000000050UL, 0Xd021264008160008UL, 0X4402004190810890UL, 0X049009860a0c1008UL, 0X8920300804a0c800UL, 0X0800402c22110084UL,
        0X200901024801b002UL, 0X4260028000040304UL, 0X00020944104a2130UL, 0Xa480218212002401UL, 0X1840a09104021020UL, 0X0500096906020004UL, 0X0000480000010258UL, 0Xc801340020920300UL,
        0X2080420830084820UL, 0X0212400401689091UL, 0X1100a00108120061UL, 0X0c00922404482104UL, 0X9612010000048401UL, 0X8828228841a00140UL, 0X0114122480424400UL, 0X108104101a609042UL,
        0X0240028329060848UL, 0X4010800510806424UL, 0X2009018442080202UL, 0X1340301160005004UL, 0X4520080900810402UL, 0X02080c269061104aUL, 0X0200040260009121UL, 0X0884480806080c00UL,
        0X205a00a480000211UL, 0X0009000204048800UL, 0X0400c82014490814UL, 0X101200805940a091UL, 0X0004000065808000UL, 0X6084032100194080UL, 0X808061121a2404c0UL, 0X0820124209040208UL,
        0X00a0010120900434UL, 0X340240929108000bUL, 0X4000021961108840UL, 0X2104086880c02504UL, 0X84010ca000042280UL, 0X8a20008a08004120UL, 0X0882110404884800UL, 0X100040a449098640UL,
        0X800c805004a20101UL, 0X41121801a0824800UL, 0X0001240041480401UL, 0X0168000200148800UL, 0X00808308224a0820UL, 0X34000000c2010489UL, 0X4a41020228820004UL, 0X0424800902820590UL,
        0X1401288092010041UL, 0X4304b0104c205000UL, 0X44000201049021a4UL, 0X2042000608640048UL, 0X5020004a01920208UL, 0X0800090422902532UL, 0X3200051001218011UL, 0Xc10d240808948808UL,
        0X04121840200b4080UL, 0X82c1052610402200UL, 0X0841220224300100UL, 0X2812d225001a4824UL, 0X0200413040040042UL, 0X890884d124201300UL, 0X00a4184400520480UL, 0X2042091091200600UL,
        0X4040840028304024UL, 0X4004080904100880UL, 0X8000000219002208UL, 0X402090012102022cUL, 0X0120584834000c00UL, 0X0090001480200443UL, 0X030020400000116dUL, 0X65004a0530884010UL,
        0X8003288418082410UL, 0X1969100040b04220UL, 0X0004c20480000004UL, 0X9608252200050001UL, 0X012910d000220204UL, 0X44160104100860a0UL, 0X8440488202280210UL, 0X4000048028229020UL,
        0X6010032980002404UL, 0X205100a081000048UL, 0X920420410100d10cUL, 0X0504420092100000UL, 0X2052201080408601UL, 0Xd000020a48100021UL, 0X4800000480484112UL, 0X1043002400042209UL,
        0X082c201244000a60UL, 0X0806400984004420UL, 0X12980020804000c1UL, 0Xc048840020a21048UL, 0X0082980812902010UL, 0X00c328000304a00aUL, 0X0040040804104244UL, 0X0480032100100500UL,
        0X0408040010691288UL, 0X1820044948840204UL, 0X0002010830806402UL, 0X1088412008491252UL, 0Xd005860100340848UL, 0X4102402184830000UL, 0X005120a240488010UL, 0X1840209001004900UL,
        0X0880400522024002UL, 0X8201050018201082UL, 0X0129908104005840UL, 0X00a20140220064a0UL, 0X94806000000d0418UL, 0X120c30800d108260UL, 0X2120c04012000020UL, 0X0203448010410258UL,
        0Xc044000829901304UL, 0X01801a0026002100UL, 0X320020140a201413UL, 0X8009204240000861UL, 0X6800426080810106UL, 0X8002048042088290UL, 0X810c009800040b09UL, 0X0092032884484406UL,
        0X02810c000a408001UL, 0X0920029028045108UL, 0X0ca0810900006010UL, 0X208028020009a400UL, 0X0004148104020200UL, 0X0120406012110904UL, 0X860a080011403048UL, 0Xd001048160040000UL,
        0X00200a0090184102UL, 0X10ca6480080106c1UL, 0X5020820148809904UL, 0X0022902084804890UL, 0X8610242018040019UL, 0X004410122400c240UL, 0X0106120024100816UL, 0X80104d0212009008UL,
        0X0001104300225040UL, 0X00140100000a2130UL, 0X000a2910c1048410UL, 0X490c120120008a01UL, 0X6004014800810420UL, 0X044a4810080c1280UL, 0X5045844028001028UL, 0X0980014406106010UL,
        0X009000a042018600UL, 0X8008004140229005UL, 0X4930580100c00802UL, 0X80020c0241001409UL, 0X9005100824008940UL, 0X61120008820a4032UL, 0X2410042200210400UL, 0X4020001001040a08UL,
        0X0012902022880484UL, 0X140b400401240653UL, 0X080c90100d028260UL, 0X2480800914000920UL, 0X2001440201400082UL, 0X0041100a4084400cUL, 0X2020084480090530UL, 0X2000212043490002UL,
        0X0208044008b60100UL, 0X2410084080410180UL, 0X12c0098612042000UL, 0X8920020004148121UL, 0X6900d100801244b4UL, 0X0418001242008040UL, 0X0228040221064900UL, 0X0820006810c00184UL,
        0X2481011091080040UL, 0X100086884c10d204UL, 0X40908a0014020c80UL, 0X245800a480212018UL, 0X484130c160101020UL, 0X0502094000094802UL, 0X021824204a208211UL, 0X0300040a0c22100cUL,
        0X2100020404484806UL, 0X12020c0018008480UL, 0X8941108205140001UL, 0X48840121a4400812UL, 0X1400280240601002UL, 0Xc200125120a04008UL, 0X4c128940301a0100UL, 0Xa001011400008002UL,
        0X0140061821221821UL, 0X0430024804900080UL, 0X0448082488050008UL, 0X0000008000060224UL, 0X04820a0090116510UL, 0X02920424486004c3UL, 0X8029061840808844UL, 0X2110c84400000110UL,
        0X141001a04b003089UL, 0X0065200040940200UL, 0X2012812022400ca2UL, 0X0088080010010482UL, 0X4140804204801100UL, 0X0424802c32400014UL, 0X0083200091000019UL, 0X4040840109204005UL,
        0X2090414000112020UL, 0X0618489290400000UL, 0X1024340148808108UL, 0X2d06180420000420UL, 0X220a009000011090UL, 0X0101841100220001UL, 0X0122004400882000UL, 0X001120060240a600UL,
        0X1928008a04a0c801UL, 0X09121224a0520080UL, 0X2400040048012408UL, 0X4048040008840240UL, 0X08148801220a6090UL, 0X90c02000d3080201UL, 0X0a08b00100001024UL, 0X20000901008000a0UL,
        0X8402042400250252UL, 0X0040a00240921024UL, 0X0022010804110822UL, 0X3000219009001442UL, 0X900922000c00006cUL, 0X0020c02000402810UL, 0X1212058201400090UL, 0X812802806104c109UL,
        0X2986100804490024UL, 0X908849300a218041UL, 0X0941808129044100UL, 0X4010004010124000UL, 0X2040210280050248UL, 0X0048900060205800UL, 0X4400004880c02880UL, 0X0212000609000280UL,
        0X1245108308100001UL, 0X2020004404082c00UL, 0X20c80500012010c0UL, 0X0224001008109804UL, 0X2412886100884016UL, 0X061008004200a680UL, 0X8104205000a04048UL, 0X01801008001840a4UL
    ];
}

partial class UInt16PrimeData {

    /// <summary>
    /// Returns true when <paramref name="value"/> is a prime (works for UInt16).
    /// </summary>
    public static bool IsPrime(UInt16 value) {
        if (value == 2) {
            return true;
        }
        if ((value & 1) == 0) {
            return false; // even and not 2
        }
        return IsOddPrime(value);
    }

    /// <summary>
    /// Returns true when <paramref name="value"/> is a prime (works for Int16).
    /// Negative values and 0/1 are not prime.
    /// </summary>
    public static bool IsPrime(Int16 value) {
        if (value < 0) {
            return false;
        }
        return IsPrime((UInt16)value);
    }

    /// <summary>
    /// Returns true when the odd <paramref name="value"/> is an odd prime.
    /// For even values this returns false.
    /// </summary>
    public static bool IsOddPrime(UInt16 value) {
        if ((value & 1) == 0) {
            return false; // even numbers are not odd primes
        }
        if (value < 3) {
            return false; // 1 is not prime
        }
        // map odd n to bit index: n >> 1
        uint bitIndex = (uint)(value >> 1);
        var bmp = OddPrimeBitmap;
        uint wordIndex = bitIndex >> 6; // divide by 64
        if (wordIndex >= (uint)bmp.Length) {
            return false;
        }
        int bitOffset = (int)(bitIndex & 63);
        return ((bmp[(int)wordIndex] >> bitOffset) & 1UL) != 0;
    }

    /// <summary>
    /// Returns true when the odd <paramref name="value"/> is an odd prime.
    /// For even values or negative values this returns false.
    /// </summary>
    public static bool IsOddPrime(Int16 value) {
        if (value < 0) {
            return false;
        }
        return IsOddPrime((UInt16)value);
    }

    /// <summary>
    /// Returns the smallest prime > <paramref name="value"/> for UInt16 inputs.
    /// </summary>
    /// <remarks>If the bitmap contains no prime > value, returns 65537 (the next prime above UInt16 range).</remarks>
    public static uint NextPrime(UInt16 value) {
        return value < 2u ? 2u : NextOddPrime(value);
    }

    /// <summary>
    /// Returns the smallest prime > <paramref name="value"/> for Int16 inputs.
    /// Negative values return 2.
    /// </summary>
    public static int NextPrime(Int16 value) {
        return value < 2 ? 2 : (int)NextOddPrime((UInt16)value);
    }

    /// <summary>
    /// Find next odd prime.
    /// </summary>
    /// <param name="value">The specified value.</param>
    /// <returns>Next odd prime greater than the specified number.</returns>
    public static uint NextOddPrime(UInt16 value) {
        Debug.Assert(IsOddPrime(value));
        unchecked {
            var bmp = OddPrimeBitmap;
            uint bitIndex = (uint)value >> 1;
            ++bitIndex;
            uint wordIndex = bitIndex >> 6;
            int bitOffset = (int)(bitIndex & 63);
            // If starting word is outside bitmap, no odd primes in-range >= candidate
            if (wordIndex >= (uint)bmp.Length) {
                return 65537u;
            }
            // First word: mask out bits below bitOffset
            {
                ulong word = bmp[(int)wordIndex];
                word &= ~0UL << bitOffset;
                if (word != 0) {
                    int tz = BitOperations.TrailingZeroCount(word);
                    uint foundBit = (wordIndex << 6) + (uint)tz;
                    uint found = (foundBit << 1) | 1u;
                    return found;
                }
                wordIndex++;
            }
            // Scan remaining words
            while (wordIndex < (uint)bmp.Length) {
                ulong word = bmp[(int)wordIndex];
                if (word != 0) {
                    int tz = BitOperations.TrailingZeroCount(word);
                    uint foundBit = (wordIndex << 6) + (uint)tz;
                    uint found = (foundBit << 1) | 1u;
                    return found;
                }
                wordIndex++;
            }
            // No prime found in bitmap strictly greater than value -> return next prime above UInt16
            return 65537u;
        }
    }
}
